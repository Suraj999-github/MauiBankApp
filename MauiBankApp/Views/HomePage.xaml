<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="MauiBankApp.Views.HomePage"
             xmlns:viewmodels="clr-namespace:MauiBankApp.ViewModels"
             xmlns:models="clr-namespace:MauiBankApp.Models"
             xmlns:views="clr-namespace:MauiBankApp.Views"
             xmlns:converters="clr-namespace:MauiBankApp.Converters"
             x:DataType="viewmodels:HomeViewModel"
             Title="">

    <ContentPage.Resources>
        <converters:TransactionTypeToIconConverter x:Key="TransactionTypeToIconConverter" />
        <converters:TransactionTypeToColorConverter x:Key="TransactionTypeToColorConverter" />
        <converters:TransactionAmountFormatConverter x:Key="TransactionAmountFormatConverter" />
    </ContentPage.Resources>

    <ScrollView>
        <VerticalStackLayout Spacing="25" Padding="20">

            <!-- Header Section -->
            <Grid ColumnDefinitions="Auto,*,Auto" 
                  VerticalOptions="Start"
                  ColumnSpacing="15">

                <!-- User Info -->
                <VerticalStackLayout Grid.Column="0" 
                                     VerticalOptions="Center">
                    <Label Text="Welcome,"
                           FontSize="14"
                           TextColor="#78909C"/>
                    <Label Text="{Binding CurrentUser.Name}" 
                           FontSize="20" 
                           FontAttributes="Bold"
                           TextColor="#37474F"/>
                </VerticalStackLayout>

                <!-- Logout Button -->
                <Button Grid.Column="2"
                        Text="Logout"
                        Command="{Binding LogoutCommand}"
                        BackgroundColor="Transparent"
                        TextColor="#546E7A"
                        FontSize="14"
                        VerticalOptions="Center"/>
            </Grid>

            <!-- Balance Card -->
            <Frame Padding="25" 
                   CornerRadius="25" 
                   BackgroundColor="#546E7A"
                   HasShadow="True">
                <VerticalStackLayout Spacing="15">
                    <Label Text="Available Balance" 
                           FontSize="16" 
                           TextColor="#CFD8DC"/>

                    <Label Text="{Binding Balance, StringFormat='${0:F2}'}" 
                           FontSize="40" 
                           FontAttributes="Bold"
                           TextColor="White"/>

                    <Grid ColumnDefinitions="*,Auto">
                        <Label Grid.Column="0"
                               Text="{Binding CurrentUser.AccountNumber, StringFormat='Account: {0}'}" 
                               FontSize="14" 
                               TextColor="#B0BEC5"/>

                        <Button Grid.Column="1"
                                Text="View Details"
                                BackgroundColor="Transparent"
                                TextColor="White"
                                FontSize="12"
                                Command="{Binding NavigateToFeatureCommand}">
                            <Button.CommandParameter>
                                <viewmodels:DashboardItem>
                                    <viewmodels:DashboardItem.Title>View Balance</viewmodels:DashboardItem.Title>
                                    <viewmodels:DashboardItem.Icon>wallet.png</viewmodels:DashboardItem.Icon>
                                    <viewmodels:DashboardItem.PageType>
                                        <x:Type TypeName="views:BalancePage" />
                                    </viewmodels:DashboardItem.PageType>
                                </viewmodels:DashboardItem>
                            </Button.CommandParameter>
                        </Button>
                    </Grid>
                </VerticalStackLayout>
            </Frame>

            <!-- Quick Actions -->
            <Grid ColumnDefinitions="*,*,*,*" 
                  RowDefinitions="Auto"
                  ColumnSpacing="10">

                <!-- Profile -->
                <Frame Grid.Column="0"
                       Padding="15"
                       CornerRadius="15" 
                       BackgroundColor="White"
                       HasShadow="True">
                    <VerticalStackLayout Spacing="10" HorizontalOptions="Center">
                        <Frame CornerRadius="12"
                               BackgroundColor="#ECEFF1"
                               HeightRequest="50"
                               WidthRequest="50"
                               Padding="12">
                            <Image Source="person.png"
                                   HeightRequest="25"
                                   WidthRequest="25"/>
                        </Frame>
                        <Label Text="Profile" 
                               FontSize="12" 
                               HorizontalOptions="Center"
                               TextColor="#455A64"/>
                    </VerticalStackLayout>
                    <Frame.GestureRecognizers>
                        <TapGestureRecognizer Command="{Binding NavigateToFeatureCommand}">
                            <TapGestureRecognizer.CommandParameter>
                                <viewmodels:DashboardItem>
                                    <viewmodels:DashboardItem.Title>Profile</viewmodels:DashboardItem.Title>
                                    <viewmodels:DashboardItem.Icon>person.png</viewmodels:DashboardItem.Icon>
                                    <viewmodels:DashboardItem.PageType>
                                        <x:Type TypeName="views:ProfilePage" />
                                    </viewmodels:DashboardItem.PageType>
                                </viewmodels:DashboardItem>
                            </TapGestureRecognizer.CommandParameter>
                        </TapGestureRecognizer>
                    </Frame.GestureRecognizers>
                </Frame>

                <!-- Send Money -->
                <Frame Grid.Column="1"
                       Padding="15"
                       CornerRadius="15" 
                       BackgroundColor="White"
                       HasShadow="True">
                    <VerticalStackLayout Spacing="10" HorizontalOptions="Center">
                        <Frame CornerRadius="12"
                               BackgroundColor="#ECEFF1"
                               HeightRequest="50"
                               WidthRequest="50"
                               Padding="12">
                            <Image Source="send.png"
                                   HeightRequest="25"
                                   WidthRequest="25"/>
                        </Frame>
                        <Label Text="Send" 
                               FontSize="12" 
                               HorizontalOptions="Center"
                               TextColor="#455A64"/>
                    </VerticalStackLayout>
                    <Frame.GestureRecognizers>
                        <TapGestureRecognizer Command="{Binding NavigateToFeatureCommand}">
                            <TapGestureRecognizer.CommandParameter>
                                <viewmodels:DashboardItem>
                                    <viewmodels:DashboardItem.Title>Send Money</viewmodels:DashboardItem.Title>
                                    <viewmodels:DashboardItem.Icon>send.png</viewmodels:DashboardItem.Icon>
                                    <viewmodels:DashboardItem.PageType>
                                        <x:Type TypeName="views:SendTransactionPage" />
                                    </viewmodels:DashboardItem.PageType>
                                </viewmodels:DashboardItem>
                            </TapGestureRecognizer.CommandParameter>
                        </TapGestureRecognizer>
                    </Frame.GestureRecognizers>
                </Frame>

                <!-- Transactions -->
                <Frame Grid.Column="2"
                       Padding="15"
                       CornerRadius="15" 
                       BackgroundColor="White"
                       HasShadow="True">
                    <VerticalStackLayout Spacing="10" HorizontalOptions="Center">
                        <Frame CornerRadius="12"
                               BackgroundColor="#ECEFF1"
                               HeightRequest="50"
                               WidthRequest="50"
                               Padding="12">
                            <Image Source="history.png"
                                   HeightRequest="25"
                                   WidthRequest="25"/>
                        </Frame>
                        <Label Text="History" 
                               FontSize="12" 
                               HorizontalOptions="Center"
                               TextColor="#455A64"/>
                    </VerticalStackLayout>
                    <Frame.GestureRecognizers>
                        <TapGestureRecognizer Command="{Binding NavigateToFeatureCommand}">
                            <TapGestureRecognizer.CommandParameter>
                                <viewmodels:DashboardItem>
                                    <viewmodels:DashboardItem.Title>Transactions</viewmodels:DashboardItem.Title>
                                    <viewmodels:DashboardItem.Icon>history.png</viewmodels:DashboardItem.Icon>
                                    <viewmodels:DashboardItem.PageType>
                                        <x:Type TypeName="views:TransactionHistoryPage" />
                                    </viewmodels:DashboardItem.PageType>
                                </viewmodels:DashboardItem>
                            </TapGestureRecognizer.CommandParameter>
                        </TapGestureRecognizer>
                    </Frame.GestureRecognizers>
                </Frame>

                <!-- QR Code -->
                <Frame Grid.Column="3"
                       Padding="15"
                       CornerRadius="15" 
                       BackgroundColor="White"
                       HasShadow="True">
                    <VerticalStackLayout Spacing="10" HorizontalOptions="Center">
                        <Frame CornerRadius="12"
                               BackgroundColor="#ECEFF1"
                               HeightRequest="50"
                               WidthRequest="50"
                               Padding="12">
                            <Image Source="qrcode.png"
                                   HeightRequest="25"
                                   WidthRequest="25"/>
                        </Frame>
                        <Label Text="QR" 
                               FontSize="12" 
                               HorizontalOptions="Center"
                               TextColor="#455A64"/>
                    </VerticalStackLayout>
                    <Frame.GestureRecognizers>
                        <TapGestureRecognizer Command="{Binding NavigateToFeatureCommand}">
                            <TapGestureRecognizer.CommandParameter>
                                <viewmodels:DashboardItem>
                                    <viewmodels:DashboardItem.Title>QR Code</viewmodels:DashboardItem.Title>
                                    <viewmodels:DashboardItem.Icon>qrcode.png</viewmodels:DashboardItem.Icon>
                                    <viewmodels:DashboardItem.PageType>
                                        <x:Type TypeName="views:QRCodePage" />
                                    </viewmodels:DashboardItem.PageType>
                                </viewmodels:DashboardItem>
                            </TapGestureRecognizer.CommandParameter>
                        </TapGestureRecognizer>
                    </Frame.GestureRecognizers>
                </Frame>
            </Grid>

            <!-- Services Section -->
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <Label Grid.Column="0"
                       Text="Services" 
                       FontSize="18" 
                       FontAttributes="Bold"
                       TextColor="#37474F"/>

                <Label Grid.Column="1"
                       Text="{Binding DashboardItems.Count, StringFormat='{0} services'}"
                       FontSize="14"
                       TextColor="#78909C"
                       VerticalOptions="Center"/>
            </Grid>

            <!-- Dynamic Dashboard Items using CollectionView -->
            <CollectionView ItemsSource="{Binding DashboardItems}"
                            Margin="0,10,0,0"
                            SelectionMode="None">
                <CollectionView.ItemsLayout>
                    <GridItemsLayout Orientation="Vertical"
                                     Span="3"
                                     VerticalItemSpacing="10"
                                     HorizontalItemSpacing="10"/>
                </CollectionView.ItemsLayout>

                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="viewmodels:DashboardItem">
                        <Frame HeightRequest="110"
                               Padding="15"
                               CornerRadius="12" 
                               BackgroundColor="White"
                               HasShadow="True">
                            <VerticalStackLayout Spacing="8" HorizontalOptions="Center">
                                <Frame CornerRadius="8"
                                       BackgroundColor="#ECEFF1"
                                       HeightRequest="50"
                                       WidthRequest="50"
                                       Padding="10">
                                    <Image Source="{Binding Icon}"
                                           HeightRequest="25"
                                           WidthRequest="25"/>
                                </Frame>
                                <Label Text="{Binding Title}" 
                                       FontSize="11" 
                                       HorizontalOptions="Center"
                                       TextColor="#546E7A"/>
                            </VerticalStackLayout>
                            <Frame.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:HomeViewModel}}, Path=NavigateToFeatureCommand}"
                                                      CommandParameter="{Binding .}"/>
                            </Frame.GestureRecognizers>
                        </Frame>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>

            <!-- Recent Transactions Section -->
            <Grid Margin="0,20,0,0">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <Label Grid.Column="0"
                       Text="Recent Transactions" 
                       FontSize="18" 
                       FontAttributes="Bold"
                       TextColor="#37474F"/>

                <Label Grid.Column="1"
                       Text="{Binding RecentTransactions.Count, StringFormat='{0} transactions'}"
                       FontSize="14"
                       TextColor="#78909C"
                       VerticalOptions="Center"/>
            </Grid>

            <!-- Loading Indicator for Recent Transactions -->
            <ActivityIndicator IsRunning="{Binding IsBusy}" 
                               IsVisible="{Binding IsBusy}"
                               HorizontalOptions="Center"
                               Color="#546E7A"
                               HeightRequest="50"
                               WidthRequest="50"/>

            <!-- Recent Transactions List -->
            <CollectionView ItemsSource="{Binding RecentTransactions}"
                            IsVisible="{Binding IsNotBusy}"
                            Margin="0,10,0,0"
                            SelectionMode="None">

                <CollectionView.EmptyView>
                    <VerticalStackLayout HorizontalOptions="Center" 
                                         VerticalOptions="Center"
                                         Spacing="10"
                                         Padding="20">
                        <Frame CornerRadius="20"
                               BackgroundColor="#ECEFF1"
                               HeightRequest="60"
                               WidthRequest="60"
                               Padding="15">
                            <Image Source="transaction.png"
                                   HeightRequest="30"
                                   WidthRequest="30"/>
                        </Frame>
                        <Label Text="No recent transactions"
                               FontSize="14"
                               TextColor="#78909C"
                               HorizontalOptions="Center"/>
                        <Button Text="Refresh"
                                Command="{Binding LoadRecentTransactionsCommand}"
                                BackgroundColor="#546E7A"
                                TextColor="White"
                                HorizontalOptions="Center"
                                WidthRequest="100"/>
                    </VerticalStackLayout>
                </CollectionView.EmptyView>

                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="models:Transaction">
                        <Frame Padding="20"
                               CornerRadius="15"
                               BackgroundColor="White"
                               HasShadow="True"
                               Margin="0,0,0,10">
                            <Grid ColumnDefinitions="Auto,*,Auto" 
                                  RowDefinitions="Auto,Auto"
                                  ColumnSpacing="15">

                                <!-- Icon -->
                                <Frame Grid.Row="0" Grid.RowSpan="2" Grid.Column="0"
                                       CornerRadius="10"
                                       BackgroundColor="#ECEFF1"
                                       HeightRequest="40"
                                       WidthRequest="40"
                                       Padding="10"
                                       VerticalOptions="Center">
                                    <Image Source="{Binding Type, Converter={StaticResource TransactionTypeToIconConverter}}"
                                           HeightRequest="20"
                                           WidthRequest="20"/>
                                </Frame>

                                <!-- Description -->
                                <Label Grid.Row="0" Grid.Column="1"
                                       Text="{Binding Description}"
                                       FontSize="14"
                                       FontAttributes="Bold"
                                       TextColor="#37474F"
                                       VerticalOptions="End"/>

                                <!-- Amount -->
                                <Label Grid.Row="0" Grid.Column="2"
                                       Text="{Binding Amount, Converter={StaticResource TransactionAmountFormatConverter}, ConverterParameter={Binding Type}}"
                                       FontSize="14"
                                       FontAttributes="Bold"
                                       TextColor="{Binding Type, Converter={StaticResource TransactionTypeToColorConverter}}"
                                       VerticalOptions="End"
                                       HorizontalOptions="End"/>

                                <!-- Recipient and Date -->
                                <Label Grid.Row="1" Grid.Column="1"
                                       Text="{Binding Recipient, StringFormat='To: {0}'}"
                                       FontSize="12"
                                       TextColor="#546E7A"
                                       VerticalOptions="Start"/>

                                <Label Grid.Row="1" Grid.Column="2"
                                       Text="{Binding Date, StringFormat='{0:MMM dd}'}"
                                       FontSize="12"
                                       TextColor="#78909C"
                                       VerticalOptions="Start"
                                       HorizontalOptions="End"/>
                            </Grid>
                        </Frame>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>

            <!-- View All Transactions Button -->
            <Button Text="View All Transactions"
                    Command="{Binding NavigateToFeatureCommand}"
                    BackgroundColor="Transparent"
                    TextColor="#546E7A"
                    FontSize="14"
                    FontAttributes="Bold"
                    HorizontalOptions="End"
                    Margin="0,10,0,0"
                    IsVisible="{Binding IsNotBusy}">
                <Button.CommandParameter>
                    <viewmodels:DashboardItem>
                        <viewmodels:DashboardItem.Title>Transactions</viewmodels:DashboardItem.Title>
                        <viewmodels:DashboardItem.Icon>history.png</viewmodels:DashboardItem.Icon>
                        <viewmodels:DashboardItem.PageType>
                            <x:Type TypeName="views:TransactionHistoryPage" />
                        </viewmodels:DashboardItem.PageType>
                    </viewmodels:DashboardItem>
                </Button.CommandParameter>
            </Button>

            <!-- Footer Spacing -->
            <BoxView HeightRequest="20"
                     Color="Transparent"/>

        </VerticalStackLayout>
    </ScrollView>
</ContentPage>